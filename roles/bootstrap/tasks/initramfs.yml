---

- name: create the initramfs staging directories
  sudo: true
  file: path={{ initramfs_root }}/{{ item }} state=directory
    owner=root group=root mode=0755
  with_items:
    - dev
    - proc
    - sys
    - usr/bin

- name: download the latest busybox source
  get_url: url={{ busybox_mirror }}/{{ busybox_filename }}
    dest={{ src_dir }}/{{ busybox_filename }}

- name: extract the busybox source
  command: tar -xf {{ src_dir }}/{{ busybox_filename }}
    chdir={{ src_dir }} creates={{ busybox_dir }}

- name: check for an existing compiled busybox binary
  command: /usr/bin/test -f {{ busybox_binary }}
  ignore_errors: true
  changed_when: false
  register: busybox_compiled

- name: remove the busybox non-source files
  command: /usr/bin/make --silent distclean
    chdir={{ busybox_dir }}
  when: busybox_compiled | failed

- name: copy the minimal busybox configuration
  copy: src=busybox.config dest={{ busybox_dir }}/.config
  when: busybox_compiled | failed

- name: compile the busybox static binary
  command: /usr/bin/make --jobs={{ nproc.stdout }} --silent
    chdir={{ busybox_dir }}
  when: busybox_compiled | failed

- name: copy the busybox binary into the initramfs
  sudo: true
  command: /usr/bin/install -D -o root -g root -m 0755 {{ busybox_binary }} {{ initramfs_root }}/usr/bin/busybox

- name: determine which functions are compiled into busybox
  command: "{{ busybox_binary }} --list"
  changed_when: false
  register: busybox_functions

- name: create the busybox function symlinks
  sudo: true
  file: src=busybox dest={{ initramfs_root }}/usr/bin/{{ item }} state=link
    owner=root group=root mode=0755
  with_items: busybox_functions.stdout_lines

- name: copy the init script into the initramfs
  sudo: true
  copy: src=initramfs.init dest={{ initramfs_root }}/init
    owner=root group=root mode=0755

- name: create the initramfs console device special file
  sudo: true
  command: /usr/bin/mknod {{ initramfs_root }}/dev/console c 5 1
    creates={{ initramfs_root }}/dev/console

- name: create the compressed initramfs archive
  sudo: true
  shell: /usr/bin/find . | /usr/bin/bsdcpio -o -H newc | /usr/bin/xz --check=crc32 --lzma2=dict=512KiB > ../initramfs.cpio.xz
    chdir={{ initramfs_root }}

- name: copy the initramfs archive to the build disk
  sudo: true
  command: /usr/bin/install -D -o root -g root -m 0644 ../initramfs.cpio.xz {{ build_mount_point }}/boot/initramfs-linux.img
    chdir={{ initramfs_root }}
